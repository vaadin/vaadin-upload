<!--
@license
Copyright (c) 2016 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-upload>` is a Polymer element for uploading multiple files with drag and drop support.

Example:

```html
<vaadin-upload>
</vaadin-upload>
```

@element vaadin-upload
@demo demo/
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="vaadin-upload">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        display: block;
        border: 1px dashed;
        border-color: var(--divider-color,  #666);
        border-radius: 2px;
        padding: 16px;
        text-align: center;
      }

      :host[dragover] {
        border-color: var(--primary-color, #03A9F4);
        opacity: 0.7;
      }

      #buttons {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);

        margin: 8px 0 0;
      }

      paper-button {
        background-color: var(--default-primary-color, #03A9F4);
        color: #fff;
      }
    </style>
    <div id="dropLabel">
      <content>Drop files here ...</content>
    </div>
    <div id="buttons">
      <paper-button id="addFiles" raised on-tap="_onAddFilesClick">Add File(s)</paper-button>
    </div>

    <input type="file" id="fileInput" on-change="_onFileInputChange" hidden multiple>

  </template>
</dom-module>

<script>

  Polymer({

    is: 'vaadin-upload',

    properties: {
      /**
       * Server URL.
       */
      target: {
        type: String,
        value: ''
      },
      /**
       * HTTP Method used to send the files.
       */
      method: {
        type: String,
        value: 'POST'
      },
      /**
       * Key-Value map to send to the server.
       */
      headers: {
        type: Object,
        value: {}
      },
      /**
       * Max time for the upload process, if exceeded XHR will be aborted.
       */
      timeout: {
        type: Number,
        value: 0
      },
      /**
       * It's true when the user overs the component with a set of files
       * and becomes false when he drops the files or leave the component.
       */
      dragover: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      }
    },

    listeners: {
      dragover: '_onDragover',
      dragleave: '_onDragleave',
      drop: '_onDrop'
    },

    _onDragover: function(event) {
      event.preventDefault();
      this.dragover = true;
    },

    _onDragleave: function(event) {
      event.preventDefault();
      this.dragover = false;
    },

    _onDrop: function(event) {
      event.preventDefault();
      this.dragover = false;
      Array.prototype.forEach.call(event.dataTransfer.files, this._addFile.bind(this));
    },

    // Override for tests
    _createXhr: function(file) {
      return new XMLHttpRequest();
    },

    _configureXhr: function(xhr) {
      if (typeof this.headers == 'string') {
        try {
          this.headers = JSON.parse(this.headers);
        } catch (e) {
          this.headers = undefined;
        }
      }
      for (var key in this.headers) {
        xhr.setRequestHeader(key, this.headers[key]);
      }
      if (this.timeout) {
        xhr.timeout = this.timeout;
      }
    },

    _uploadFile: function(file) {
      var ini = new Date().getTime();
      var xhr = file.xhr = this._createXhr(file);
      var stalledId;

      // onprogress is called always after onreadystatechange
      xhr.upload.onprogress = function(e) {
        clearTimeout(stalledId);

        last = new Date().getTime();
        var ellapsed = (last - ini) / 1000;
        var done = e.loaded, total = e.total, progress = ~~(done / total * 100);

        file.loaded = done;
        file.progress = progress;
        file.status = file.totalStr + ' (' + file.progress + '%)' ;
        file.indeterminate = done <= 0 || done >= total, true;

        if (progress < 100) {
          file.remaining = 1 + ~~(ellapsed * (100 / progress - 1));
          file.speed = ~~(total / ellapsed / 1024);
          file.totalStr = total > (1024 * 1024) ?
            ((~~(total / 1024 / 1024 * 10) / 10) + ' MB') : (~~(total / 1024) + ' KB');
          file.doneStr = done > (1024 * 1024) ?
            ((~~(done / 1024 / 1024 * 10) / 10) + ' MB') : (~~(done / 1024) + ' KB');
          file.status += ' about ' + file.remaining + ' seconds remaining.';
        } else {
          file.status = 'Processing file ...';
          file.uploading = false;
        }
        this.fire('upload-progress', {file: file, xhr: xhr});

        stalledId = setTimeout(function() {
          file.status = 'Stalled.';
        }.bind(this), 2000);

      }.bind(this);

      // More reliable than xhr.onload
      xhr.onreadystatechange = function(e) {
        if (xhr.readyState == 4) {
          clearTimeout(stalledId);
          file.indeterminate = file.uploading = file.status = false;
          if (file.abort) {
            file.error = file.complete = file.progress = false;
            return;
          }
          // Custom listener can modify the default behavior either
          // preventing default, changing the xhr, or setting the file error
          var evt = this.fire('upload-response', {file: file, xhr: xhr}, {cancelable: true});
          if (evt.defaultPrevented) {
            return;
          }
          if (xhr.status === 0) {
            file.error = 'Server Unavailable';
          } else if (xhr.status > 500) {
            file.error = 'Unexpected Server Error';
          } else if (xhr.status > 400) {
            file.error = 'Forbiden';
          }

          file.complete = !file.error;
          this.fire('upload-' + (file.error ? 'error' : 'success'), {file: file, xhr: xhr});
        }
      }.bind(this);

      var formData = new FormData();
      formData.append('file', file, file.name);

      file.uploadTarget = this.target;
      var evt = this.fire('upload-before', {file: file, xhr: xhr}, {cancelable: true});
      if (evt.defaultPrevented) {
        return;
      }

      xhr.open(this.method, file.uploadTarget, true);
      this._configureXhr(xhr);

      // Custom listener could modify the xhr just before sending it
      // preventing default
      var evt = this.fire('upload-request', {file: file, xhr: xhr}, {cancelable: true});
      if (evt.defaultPrevented) {
        return;
      }

      file.status = 'Connecting ...';
      file.indeterminate = true;
      file.abort = undefined;
      file.uploading = true;
      this.fire('upload-start', {file: file, xhr: xhr});
      xhr.send(formData);
    },

    /**
     * Add the file for uploading. Called internally for each file after picking files from dialog or dropping files.
     *
     * @param {File} file File being added
     */
    _addFile: function(file) {
      this.fire('file-add', {file: file});
      this._uploadFile(file);
    },

    _onAddFilesClick: function(event) {
      if (document.createEvent) {
        var ev = document.createEvent('MouseEvents');
        ev.initEvent('click', true, false);
        this.$.fileInput.dispatchEvent(ev);
      }
    },

    _onFileInputChange: function(event) {
      Array.prototype.forEach.call(event.target.files, this._addFile.bind(this));
    }
  });
  /**
   * Fired when a file is added for uploading.
   *
   * @event file-add
   * @param {Object} detail
   *  @param {Object} detail.file the file added
   */
  /**
   * Fired before the XHR is opened. Could be used for changing the request
   * URL. If the default is prevented, then XHR would not be opened.
   *
   * @event upload-before
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded
   *   @param {Object} detail.file.uploadTarget the upload request URL, initialized with the value of vaadin-upload `target` property
   */
  /**
   * Fired when the XHR has been opened but not sent yet.
   * Useful to change some parameters like headers, etc.
   * If the event is preventDefault `vaadin-upload` will not send the
   * request allowing the user to do something on his own.
   *
   * @event upload-request
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded
   */
  /**
   * Fired when the XHR is sent.
   *
   * @event upload-start
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded
   */
  /**
   * Fired as many times as the progress is updated.
   *
   * @event upload-progress
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded with loaded info
   */
  /**
   * Fired when we have the actual server response, and before the component
   * analises it. It's useful for developers to make the upload fail depending
   * on the server response. If the event is preventDefault the vaadin-upload
   * will return allowing the user to do something on his own like retry the
   * upload, etc. since he has full access to the `xhr` and `file` objects.
   * Otherwise, if the event is not prevented default `vaadin-upload` continues
   * with the normal workflow checking the `xhr.status` and `file.error`
   * which also might be modified by the user to force a customised response.
   *
   * @event upload-response
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded
   */
  /**
   * Fired in case the upload process succeed.
   *
   * @event upload-success
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded with loaded info
   */
  /**
   * Fired in case the upload process failed.
   *
   * @event upload-error
   * @param {Object} detail
   *  @param {Object} detail.xhr the xhr
   *  @param {Object} detail.file the file being uploaded
   */

</script>
