<!--
@license
Copyright (c) 2016 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-upload>` is a Polymer element for uploading multiple files with drag and drop support.

Example:

```html
<vaadin-upload>
</vaadin-upload>
```

@element vaadin-upload
@demo demo/
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="vaadin-upload">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
      }

      #buttons {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);

        margin: 8px 0 0;
      }

      paper-button {
        background-color: var(--default-primary-color, #03A9F4);
        color: #fff;
      }
    </style>

    <div id="buttons">
      <paper-button id="addFiles" raised on-tap="_onAddFilesClick">Add File(s)</paper-button>
    </div>

    <input type="file" id="fileInput" on-change="_onFileInputChange" hidden multiple>

  </template>
</dom-module>

<script>

  Polymer({

    is: 'vaadin-upload',

    properties: {
      target: {
        type: String
      },
      method: {
        type: String,
        value: 'POST'
      }
    },

    /**
     * Fired when a file is added for uploading.
     *
     * @event file-add
     */

    // Override for tests
    _createXhr: function() {
      return new XMLHttpRequest();
    },

    _uploadFile: function(file) {
      var xhr = file.xhr = this._createXhr();
      console.log("Uploading file: ", file.name);
      xhr.upload.onprogress = function(e) {
        console.log("Progress", e);
      }.bind(this);

      var url = this.target;
      xhr.open(this.method, url, true);

      xhr.onreadystatechange = function(e) {
        // console.log(xhr.readyState, xhr.status, xhr.responseText);
        if (xhr.readyState == 4 && xhr.status == 200) {
          console.log("Uploaded file: ", file.name, xhr.responseText);
          this.fire("file-uploaded", {xhr: xhr, file: file});
        }
      }.bind(this);

      var formData = new FormData();
      formData.append("file", file, file.name);

      xhr.send(formData);
    },

    /**
     * Add the file for uploading. Called internally for each file after picking files from dialog or dropping files.
     *
     * @param {File} file File being added
     */
    _addFile: function(file) {
      this.fire('file-add', {file: file});
    },

    _onAddFilesClick: function(event) {
      if (document.createEvent) {
        var event = document.createEvent("MouseEvents");
        event.initEvent("click", true, false);
        this.$.fileInput.dispatchEvent(event);
      }
    },

    _onFileInputChange: function(event) {
      Array.prototype.forEach.call(event.target.files, this._addFile.bind(this));
    }
  });

</script>
